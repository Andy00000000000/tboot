<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started with the Tilted Bootstrap • tboot</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with the Tilted Bootstrap">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tboot</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tboot.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/exp_tilting.html">Exponential Tilting Simulations</a>
    </li>
    <li>
      <a href="../articles/tboot_bmr.html">Gettings Started with Bayesian Marginal Reconstruction</a>
    </li>
    <li>
      <a href="../articles/tboot_bmr_vs_joint_bayes.html">Bayesian Marginal Reconstruction Simulations</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nmorris-lilly/tboot">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Getting Started with the Tilted Bootstrap</h1>
                        <h4 class="author">Nathan Morris, Will Landau</h4>
            
            <h4 class="date">2020-06-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nmorris-lilly/tboot/blob/master/vignettes/tboot.Rmd"><code>vignettes/tboot.Rmd</code></a></small>
      <div class="hidden name"><code>tboot.Rmd</code></div>

    </div>

    
    
<div id="tilted-bootstrap" class="section level1">
<h1 class="hasAnchor">
<a href="#tilted-bootstrap" class="anchor"></a>Tilted Bootstrap</h1>
<p>The tilted bootstrap is a weighted resampling technique. The goal is to take a reasonably realistic sample of the rows of dataset in such a way that the column means approximate a user-defined target. In other words, the user can control the marginal means while still preserving intricate relationships among the variables. The “Tilted Bootstrap” is related to the inferential methods proposed by Efron and others <span class="citation">(Efron 1981)</span>. However, the methods implemented in the ‘tboot’ package are used in a multivariate situation and intended for simulating future outcomes instead of making inference.</p>
<p>This vignette is a tutorial on the use of the ‘tboot’ and ‘tweights’ functions which may be used for ‘scenario based’ frequentist simulations. That is, the user must specify the exact mean for each variable to perform the simulation. An alternative Bayesian approach where the user specifies a marginal distribution is also implemented in the ‘tboot’ package in the ‘tboot_bmr,’ ‘post_bmr,’ and ‘tweights_bmr.’ A seperate vignette is available as a tutorial for the Bayesian approach.</p>
</div>
<div id="a-simulated-example-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#a-simulated-example-dataset" class="anchor"></a>A simulated example dataset</h1>
<p>As and example, we simulate the following simple dataset with some categorical, continuous and binary variables.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tboot)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">2018</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">color   &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"brown"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span>), <span class="dv">300</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">quant1  &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">300</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(color<span class="op">==</span><span class="st">"red"</span>, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">quant2  &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">300</span>) <span class="op">+</span><span class="st"> </span>quant1<span class="op">*</span>.<span class="dv">5</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">bin1    &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(quant1<span class="op">+</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">300</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">bin2    &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(quant2<span class="op">+</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">300</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">simData &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(color, quant1, quant2, bin1, bin2)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(simData)</a></code></pre></div>
<pre><code>##   color      quant1     quant2 bin1 bin2
## 1  blue -1.57511390 -0.3168474    0    0
## 2  blue  1.06242723  0.8183064    0    0
## 3  blue -0.04002905 -0.5788625    0    0
## 4 brown -0.71129317 -0.8974168    0    0
## 5 green  0.26670057 -0.2256420    1    0
## 6 brown  1.04736902  0.0748104    1    0</code></pre>
<p>To use the ‘tboot’ package we must first code the variables as numeric matrix. To do this, we code the ‘color’ variable above with two dummy variables.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">dataset=<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    <span class="dt">colorBlue=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(simData<span class="op">$</span>color<span class="op">==</span><span class="st">"blue"</span>,<span class="dv">1</span>,<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="dt">colorBrown=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(simData<span class="op">$</span>color<span class="op">==</span><span class="st">"brown"</span>,<span class="dv">1</span>,<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    simData[,<span class="op">-</span><span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(dataset)</a></code></pre></div>
<pre><code>##   colorBlue  colorBrown      quant1      quant2        bin1        bin2 
##  0.32000000  0.33333333 -0.06706536 -0.06444624  0.22333333  0.24333333</code></pre>
</div>
<div id="example-1-constraining-the-mean-for-all-variables-in-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#example-1-constraining-the-mean-for-all-variables-in-the-data" class="anchor"></a>Example 1: Constraining the mean for all variables in the data</h1>
<p>Suppose that, in the bootstrapped dataset, we want all the column means to be around 0.4.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">target &lt;-<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">colorBlue=</span><span class="fl">0.4</span>,</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">             <span class="dt">colorBrown=</span><span class="fl">0.4</span>,</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">             <span class="dt">quant1=</span><span class="fl">0.4</span>,</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">             <span class="dt">quant2=</span><span class="fl">0.4</span>,</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">             <span class="dt">bin1=</span><span class="fl">0.4</span>,</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">             <span class="dt">bin2=</span><span class="fl">0.4</span>) </a></code></pre></div>
<p>We now need to find the row-level resampling weights. The weights are as close to uniform as possible while still making sure the bootstrap approximates the target column means.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">weights &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tweights.html">tweights</a></span>(<span class="dt">dataset =</span> dataset, <span class="dt">target =</span> target)</a></code></pre></div>
<pre><code>## ----------------------------------------------------------------
## Optimization was successful. The weights have a sampleing
## distribution with means close to the attemted target:
##               colorBlue colorBrown quant1 quant2 bin1 bin2
## Achieved Mean       0.4        0.4    0.4    0.4  0.4  0.4
## Target Mean         0.4        0.4    0.4    0.4  0.4  0.4
## Maximum weight was:  0.01383739 
## ----------------------------------------------------------------</code></pre>
<p>Next, we bootstrap a very large sample using the weights.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">boot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tboot.html">tboot</a></span>(<span class="dt">weights =</span> weights, <span class="dt">nrow =</span> <span class="fl">1e5</span>)</a></code></pre></div>
<p>The column means are close to the target even though all the rows came from the original data.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(boot)</a></code></pre></div>
<pre><code>##  colorBlue colorBrown     quant1     quant2       bin1       bin2 
##  0.4020400  0.4003600  0.3968286  0.3986242  0.3984800  0.4004900</code></pre>
<p>The weights for each sample will now differ:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(weights<span class="op">$</span>weights, <span class="dt">breaks=</span><span class="dv">25</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dt">v=</span><span class="dv">1</span><span class="op">/</span><span class="dv">300</span>,<span class="dt">col=</span><span class="st">"red"</span>)</a></code></pre></div>
<p><img src="tboot_files/figure-html/hist-1.png" width="700"></p>
<p>The red line in the histogram above represents the probability for uniform resampling. We recommend against using the resampling methods implemented in this package when the weight of any one sample is too high. In some cases, this may be improved by transforming variables or removing/Winsorizing outlier samples. Also, using a different distance measure as described below in the section on Methodology may help. In general, if the target value is far from the observed mean of your data, it is likely that a handful of samples will be highly weighted.</p>
</div>
<div id="example-2-constraining-the-mean-for-a-subset-of-the-variables" class="section level1">
<h1 class="hasAnchor">
<a href="#example-2-constraining-the-mean-for-a-subset-of-the-variables" class="anchor"></a>Example 2: Constraining the mean for a subset of the variables</h1>
<p>Suppose we wish to constrain the mean for only as subset of the variables. For example, we may wish to constrain only the variables ‘quant2’ and ‘bin1’ to have a mean value of 0.4 and 0.5 respectively. We would determine the weights as follows:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">weights &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tweights.html">tweights</a></span>(<span class="dt">dataset =</span> dataset, </a>
<a class="sourceLine" id="cb12-2" data-line-number="2">                    <span class="dt">target =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">quant1=</span><span class="fl">0.5</span>, <span class="dt">quant2=</span><span class="fl">0.5</span>))</a></code></pre></div>
<pre><code>## ----------------------------------------------------------------
## Optimization was successful. The weights have a sampleing
## distribution with means close to the attemted target:
##               quant1 quant2
## Achieved Mean    0.5    0.5
## Target Mean      0.5    0.5
## Maximum weight was:  0.01178888 
## ----------------------------------------------------------------</code></pre>
<p>We can now bootstrap from the entire dataset as like this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">boot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tboot.html">tboot</a></span>(weights, <span class="dt">nrow =</span> <span class="fl">1e5</span>)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(<span class="st">"dataset mean"</span>    =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(dataset),</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">      <span class="st">"tbootstrap mean"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(boot))</a></code></pre></div>
<pre><code>##                 colorBlue colorBrown      quant1      quant2      bin1
## dataset mean       0.3200  0.3333333 -0.06706536 -0.06444624 0.2233333
## tbootstrap mean    0.2765  0.3531700  0.49919188  0.49463529 0.3444700
##                      bin2
## dataset mean    0.2433333
## tbootstrap mean 0.3835500</code></pre>
<p>As may be seen, by changing the target mean of ‘quant2’ and ‘bin1’ we have also significantly changed the mean of other variables such as ‘quant1’ and ‘bin2.’ In many cases this is exactly what we would want to do, but it may occasionally be problematic. For example, if the one of the variables is a baseline variable in a clinical trial. In this case, it is recommended that the user constrain the mean of the baseline covariate to be the same as in the observed data.</p>
<p>The actual weights for each sample may be extracted as ‘weights$weigths.’ As an instructive look at what the weights represent here is a graph of the weights. The red point marks the position of the new assumed mean while the black point marks the position of the data sample mean.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">pltdta=<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(dataset[,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"quant1"</span>, <span class="st">"quant2"</span>)], <span class="dt">weights=</span>weights<span class="op">$</span>weights)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</a></code></pre></div>
<pre><code>## Registered S3 methods overwritten by 'ggplot2':
##   method         from 
##   [.quosures     rlang
##   c.quosures     rlang
##   print.quosures rlang</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(pltdta, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>quant1, <span class="dt">y=</span>quant2, <span class="dt">color=</span>weights)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>.<span class="dv">6</span>, <span class="dt">y=</span>.<span class="dv">6</span>), <span class="dt">shape =</span> <span class="dv">3</span>, <span class="dt">colour =</span> <span class="st">"red"</span>, <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">stroke =</span> <span class="dv">3</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(pltdta<span class="op">$</span>quant1), <span class="dt">y=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(pltdta<span class="op">$</span>quant2)),</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">             <span class="dt">shape =</span> <span class="dv">3</span>, <span class="dt">colour =</span> <span class="st">"black"</span>,  <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">stroke =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="tboot_files/figure-html/boot21-1.png" width="700"></p>
</div>
<div id="example-3-constraining-the-mean-and-variance-for-a-variable" class="section level1">
<h1 class="hasAnchor">
<a href="#example-3-constraining-the-mean-and-variance-for-a-variable" class="anchor"></a>Example 3: Constraining the mean and variance for a variable</h1>
<p>The variance can also be constrained by creating a variable with the second moment. For example, suppose we wanted to constrain the variance of quant1 to 0.75 and the mean to be 0.5 . We could do as follows:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">dataset=<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(dataset, <span class="dt">quant1_2=</span> (dataset[,<span class="st">"quant1"</span>]<span class="op">-</span><span class="fl">0.5</span>)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">weights &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tweights.html">tweights</a></span>(<span class="dt">dataset =</span> dataset, </a>
<a class="sourceLine" id="cb19-3" data-line-number="3">                    <span class="dt">target =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">quant1=</span><span class="fl">0.5</span>, <span class="dt">quant1_2=</span><span class="fl">0.75</span>),)</a></code></pre></div>
<pre><code>## ----------------------------------------------------------------
## Optimization was successful. The weights have a sampleing
## distribution with means close to the attemted target:
##               quant1 quant1_2
## Achieved Mean    0.5     0.75
## Target Mean      0.5     0.75
## Maximum weight was:  0.006857805 
## ----------------------------------------------------------------</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">boot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tboot.html">tboot</a></span>(weights, <span class="dt">nrow =</span> <span class="fl">1e5</span>)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(dataset[,<span class="st">"quant1"</span>])</a></code></pre></div>
<pre><code>## [1] 1.097222</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(boot[,<span class="st">"quant1"</span>])</a></code></pre></div>
<pre><code>## [1] 0.7537766</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(<span class="st">"dataset mean"</span>    =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(dataset),</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">      <span class="st">"tbootstrap mean"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(boot))</a></code></pre></div>
<pre><code>##                 colorBlue colorBrown      quant1      quant2      bin1
## dataset mean       0.3200  0.3333333 -0.06706536 -0.06444624 0.2233333
## tbootstrap mean    0.2884  0.3573000  0.50772144  0.19314284 0.3379400
##                      bin2  quant1_2
## dataset mean    0.2433333 1.4151279
## tbootstrap mean 0.2971900 0.7538286</code></pre>
</div>
<div id="methodology" class="section level1">
<h1 class="hasAnchor">
<a href="#methodology" class="anchor"></a>Methodology</h1>
<p>The goal is to find a bootstrap resampling distribution that</p>
<ol style="list-style-type: decimal">
<li>is close to uniform. That way, the tilted bootstrap is as close to an ordinary bootstrap as possible.</li>
<li>generates bootstrap datasets with the desired column means.</li>
</ol>
<div id="stating-the-optimization-problem" class="section level2">
<h2 class="hasAnchor">
<a href="#stating-the-optimization-problem" class="anchor"></a>Stating the optimization problem</h2>
<p>Let <span class="math inline">\(q = (q_1, \ldots, q_n)\)</span> be the resampling distribution. Here, <span class="math inline">\(n\)</span> is the number of rows in the original dataset, and <span class="math inline">\(q_i\)</span> is the probability that row <span class="math inline">\(i\)</span> will be chosen for a given row of the bootstrap dataset. Let <span class="math inline">\(p = (p_1, \ldots, p_n)\)</span> be uniform (i.e., <span class="math inline">\(p_i = 1/n\)</span>, the resampling distribution of the ordinary bootstrap).</p>
<p>We want to find a <span class="math inline">\(q\)</span> that is as close to <span class="math inline">\(p\)</span> as possible. We consider three possible measures of distance. First, the Euclidean distance is defined as: <span class="math display">\[
D_{Euclidian}= \sum_{i = 1}^n (p_i - q_i)^2
\]</span> Second, the Backwards Kullback-Leibler (KL) divergence (which is technically not considered a distance metric) from <span class="math inline">\(p\)</span> to <span class="math inline">\(q\)</span> is defined as: <span class="math display">\[
\begin{aligned}
D_{KL}(q||p) 
&amp;= \sum_{i = 1}^n q_i \log \frac{q_i}{p_i} \\
&amp;= \sum_{i = 1}^n q_i \log nq_i 
\end{aligned}
\]</span></p>
<p>Third, the Forwards Kullback-Leibler (KL) divergence from <span class="math inline">\(q\)</span> to <span class="math inline">\(p\)</span> is defined as: <span class="math display">\[
D_{KL}(p||q) = \sum_{i = 1}^n p_i \log \frac{p_i}{q_i} \\
\]</span></p>
<p>Note that minimizing <span class="math inline">\(D_{KL}(p||q)\)</span> is the same as minimizing <span class="math inline">\(-\sum_{i = 1}^n \log q_i\)</span>.</p>
<p>The goal of determining the weights for the ‘tilted bootstrap’ may be formulated as a constrained optimization problem: <span class="math display">\[
q=\underset{q \in S}{\operatorname{argmin}} {D(p,q)}
\]</span> where,</p>
<p><span class="math display">\[
S=\{q|\space q_i&gt;0 \space for \space i \in {1...n}, \space and \space  \sum_{i = 1}^n q_i=1, \space and \space X^Tq = y \space \}.
\]</span> Here <span class="math inline">\(y\)</span> is a vector of target means for the columns.</p>
</div>
<div id="solving-the-optimization-problem" class="section level2">
<h2 class="hasAnchor">
<a href="#solving-the-optimization-problem" class="anchor"></a>Solving the optimization problem</h2>
<p>In the case of the Euclidean distance the problem is a standard “Quadratic Programming” problem which we solve using the ‘solve.QP’ function from the ‘quadprog’ package.</p>
<p>To solve the problem for the Backwards KL distance, we use the Lagrangian approach. Define <span class="math inline">\(A=[X|1]\)</span> (i.e. <span class="math inline">\(A\)</span> is the concatenation of <span class="math inline">\(X\)</span> with a conformal column of all ones). Also, let <span class="math inline">\(b=[y^T|1]^T\)</span> (i.e <span class="math inline">\(b\)</span> is the <span class="math inline">\(y\)</span> vector with a one element concatenated to the end). The Lagrangian for this optimization problem is</p>
<p><span class="math display">\[
\begin{aligned}
L(q, \lambda) &amp;= \sum_{i = 1}^n q_i \log nq_i  + \lambda (A'q - b) \\
&amp;= \sum_{i = 1}^n \left [ q_i \log nq_i +  \sum_{k = 1}^{K+1} \lambda_k (A_{ik} q_i - b_k) \right ]
\end{aligned}
\]</span></p>
<p>where</p>
<ul>
<li>The vector <span class="math inline">\(\lambda\)</span> of length <span class="math inline">\(K+1\)</span> represents the Lagrange multipliers.</li>
<li>
<span class="math inline">\(K\)</span> is the number of columns of <span class="math inline">\(X\)</span>.</li>
<li>
<span class="math inline">\(A_{ik}\)</span> is the element of <span class="math inline">\(A\)</span> in row <span class="math inline">\(i\)</span> and column <span class="math inline">\(k\)</span>.</li>
</ul>
<p>To optimize, we start by setting the gradient of <span class="math inline">\(L\)</span> equal to zero and solve for a locally optimal <span class="math inline">\(q\)</span> in terms of <span class="math inline">\(\lambda\)</span>. <span class="math display">\[
\begin{aligned}
0 &amp;= \left . \frac{\partial L}{\partial q_i} \right |_{(q, \ \lambda)}  \\
&amp;= \log nq_i + \frac{1}{n} + A_i' \lambda \\
\log nq_i &amp;=   -\frac{1}{n} - A_i' \lambda \\
q_i &amp;= e^{-A_i' \lambda^*}
\end{aligned}
\]</span> Here, <span class="math inline">\(\lambda^*\)</span> is scaled and recentered to absorb the constants in the equation.</p>
<p>Here, <span class="math inline">\(X_i\)</span> is the <span class="math inline">\(i\)</span>’th row of <span class="math inline">\(X\)</span> (expressed as a column vector). Hence, the locally optimal <span class="math inline">\(q\)</span> in terms of the vector <span class="math inline">\(\lambda^*\)</span> is</p>
<p><span class="math display">\[q^*(\lambda^*) = \left (e^{-A_1' \lambda^*}, \ldots, e^{-A_n' \lambda^*} \right ) \]</span> To find <span class="math inline">\(\lambda^*\)</span>, we solve the equation <span class="math inline">\(A'q^*(\lambda^*) = b\)</span> by using the Newton-Raphson algorithm. Thus, it turns out that backwards version of the KL distance results in what is called “exponential tilting.” Some of the elegant properties of exponential tilting are described in a different vignette.</p>
<p>Similarly, it may be shown for the forward version of the KL, that the locally optimal <span class="math inline">\(q\)</span> in terms of <span class="math inline">\(\lambda\)</span> is</p>
<p><span class="math display">\[q^*(\lambda) = \left (\frac{1}{A_1^T \lambda}, \ldots, \frac{1}{  A_n^T \lambda} \right ) \]</span></p>
<p>However, tboot’s current implementation of forward KL distance is not very stable. A warning will be issued if the user selects the forward KL distance in the tboot package.</p>
</div>
</div>
<div id="problems-encountered-for-some-data" class="section level1">
<h1 class="hasAnchor">
<a href="#problems-encountered-for-some-data" class="anchor"></a>Problems encountered for some data</h1>
<div id="not-full-rank" class="section level2">
<h2 class="hasAnchor">
<a href="#not-full-rank" class="anchor"></a>Not full rank</h2>
<p>If the data matrix used to determine the weights is not full rank, tweights will likely fail. Consider reducing the number of columns being constrained to deal with this issue.</p>
</div>
<div id="constraint-not-achievable" class="section level2">
<h2 class="hasAnchor">
<a href="#constraint-not-achievable" class="anchor"></a>Constraint not achievable</h2>
<p>Sometimes the desired constraint may not be achievable. This often occurs when the desired target differs from the data by a large amount. If the target is not achievable, tweights will give a warning, then it will find the “closest” achievable constraint. “Closest” is measured by a weighted euclidean distance. Thus the target (<span class="math inline">\(y\)</span>) is replaced with: <span class="math display">\[
y_{new}=X'q^*
\]</span> where <span class="math display">\[
q^*=\underset{q^* \in S^*}{\operatorname{argmin}} {(X'q - y)'W(X'q - y)}
\]</span> and <span class="math inline">\(S^*={q^*|\space \sum_{i = 1}^n q_i^* = 1}\)</span>. The weights (<span class="math inline">\(W\)</span>) is a diagonal matrix with diagonal entries <span class="math inline">\(W_{kk}=1/s^2_k\)</span> where <span class="math inline">\(s^2_k\)</span> is the sample variance of column <span class="math inline">\(k\)</span> from the data matrix (<span class="math inline">\(X\)</span>). We solve this problem using the ‘ipop’ function in the ‘kernlap’ package. Note that ‘kernlab’ is used instead of ‘quadprog’ because the problem is not easily formulated using a full rank matrix for the quadratic form in the problem.</p>
</div>
<div id="unable-to-find-an-optimum" class="section level2">
<h2 class="hasAnchor">
<a href="#unable-to-find-an-optimum" class="anchor"></a>Unable to find an optimum</h2>
<p>The algorithm may fail to converge properly, and an error or warning will be issued.</p>
</div>
<div id="some-samples-have-a-very-high-weight" class="section level2">
<h2 class="hasAnchor">
<a href="#some-samples-have-a-very-high-weight" class="anchor"></a>Some samples have a very high weight</h2>
<p>As previously mentioned if any sample is too highly weighted, the tilted bootstrap approach is not recommended. See Example 1 above for more discussion about this issue.</p>
</div>
<div id="augmented-sampling-to-improved-stability" class="section level2">
<h2 class="hasAnchor">
<a href="#augmented-sampling-to-improved-stability" class="anchor"></a>Augmented Sampling to Improved Stability</h2>
<p>In many cases, the problems described above can be avoided by the use of the ‘Nindependent’ option in the ‘tweights’ function. We suggest that typically, if this option is used, the user set Nindependent=1. This means that one one additional “special” sample is assumed to exist in the original data. If ‘tboot’ draws this special sample, it will proceed to bootstrap each variable independently so that the variables are independent for that patient. The weights for each independent variable bootstrap are set so that (if possible) the “special” sample would average to the target. In effect, the Nindependent option makes the correlation structure slightly less dependent. In exchange for the small bias created, the user will be able to better achieve a target even when the dataset available is small or ill-conditioned. This method is used for the Bayesian marginal reconstruction method as it helps eliminate errors in corners of the parameters space that do not fit well with the data but still occasionally occur. In these cases, the independent sample may occur frequently, so the simulation defaults towards greater independence when the data is not consistent with the parameter. Here is an example of using the Nindependent option where correlation is slightly smaller with augmentation:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">x1=<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">x2=<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1000</span>)<span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(.<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span>x1<span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(.<span class="dv">9</span>)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">dataset2=<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x1=</span>x1, <span class="dt">x2=</span>x2)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"></a>
<a class="sourceLine" id="cb27-5" data-line-number="5">weights_no_augmentation &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tweights.html">tweights</a></span>(<span class="dt">dataset =</span> dataset2, </a>
<a class="sourceLine" id="cb27-6" data-line-number="6">                    <span class="dt">target =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">x1=</span><span class="fl">0.2</span>, <span class="dt">x2=</span><span class="op">-</span><span class="fl">0.2</span>))</a></code></pre></div>
<pre><code>## ----------------------------------------------------------------
## Optimization was successful. The weights have a sampleing
## distribution with means close to the attemted target:
##                      x1         x2
## Achieved Mean 0.1999998 -0.2000002
## Target Mean   0.2000000 -0.2000000
## Maximum weight was:  0.04102889 
## ----------------------------------------------------------------</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">weights_augmentation &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tweights.html">tweights</a></span>(<span class="dt">dataset =</span> dataset2, </a>
<a class="sourceLine" id="cb29-2" data-line-number="2">                    <span class="dt">target =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">x1=</span><span class="fl">0.2</span>, <span class="dt">x2=</span><span class="op">-</span><span class="fl">0.2</span>), <span class="dt">Nindependent=</span><span class="dv">1</span>)</a></code></pre></div>
<pre><code>## ----------------------------------------------------------------
## Optimization was successful. The weights have a sampleing
## distribution with means close to the attemted target:
##                      x1         x2
## Achieved Mean 0.1999998 -0.2000001
## Target Mean   0.2000000 -0.2000000
## Maximum weight was:  0.0409359 
## Data augmented with 1 sample(s) with independent variables. 
## The final weight of the indpendent sample(s) was:  0.002266406 
## ----------------------------------------------------------------</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">boot_no_augmentation &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tboot.html">tboot</a></span>(weights_no_augmentation, <span class="dt">nrow =</span> <span class="fl">1e5</span>)</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">boot_augmentation &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tboot.html">tboot</a></span>(weights_augmentation, <span class="dt">nrow =</span> <span class="fl">1e5</span>)</a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(boot_no_augmentation)</a></code></pre></div>
<pre><code>##           x1        x2
## x1 1.0000000 0.9400113
## x2 0.9400113 1.0000000</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(boot_augmentation)</a></code></pre></div>
<pre><code>##           x1        x2
## x1 1.0000000 0.9376946
## x2 0.9376946 1.0000000</code></pre>
</div>
</div>
<div id="bibliography" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#bibliography" class="anchor"></a>Bibliography</h1>
<div id="refs" class="references">
<div id="ref-efron1981nonparametric">
<p>Efron, Bradley. 1981. “Nonparametric Standard Errors and Confidence Intervals.” <em>Canadian Journal of Statistics</em> 9 (2). Wiley Online Library: 139–58.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#tilted-bootstrap">Tilted Bootstrap</a></li>
      <li><a href="#a-simulated-example-dataset">A simulated example dataset</a></li>
      <li><a href="#example-1-constraining-the-mean-for-all-variables-in-the-data">Example 1: Constraining the mean for all variables in the data</a></li>
      <li><a href="#example-2-constraining-the-mean-for-a-subset-of-the-variables">Example 2: Constraining the mean for a subset of the variables</a></li>
      <li><a href="#example-3-constraining-the-mean-and-variance-for-a-variable">Example 3: Constraining the mean and variance for a variable</a></li>
      <li>
<a href="#methodology">Methodology</a><ul class="nav nav-pills nav-stacked">
<li><a href="#stating-the-optimization-problem">Stating the optimization problem</a></li>
      <li><a href="#solving-the-optimization-problem">Solving the optimization problem</a></li>
      </ul>
</li>
      <li>
<a href="#problems-encountered-for-some-data">Problems encountered for some data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#not-full-rank">Not full rank</a></li>
      <li><a href="#constraint-not-achievable">Constraint not achievable</a></li>
      <li><a href="#unable-to-find-an-optimum">Unable to find an optimum</a></li>
      <li><a href="#some-samples-have-a-very-high-weight">Some samples have a very high weight</a></li>
      <li><a href="#augmented-sampling-to-improved-stability">Augmented Sampling to Improved Stability</a></li>
      </ul>
</li>
      <li><a href="#bibliography">Bibliography</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nathan Morris, William Michael Landau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
